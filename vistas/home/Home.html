<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CineReseÃ±as - Inicio</title>
  <link rel="stylesheet" href="Home.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>

<body>
  <header class="top-bar">
    <h1 class="logo">ğŸ¬ Filmly</h1>
    <button class="search-nav-btn" onclick="location.href='../search-results/Search-results.html'" aria-label="Buscar">
      ğŸ”
    </button>
  </header>

  <main class="movies-section">
    
    <h2 class="section-title">ğŸ”¥ PelÃ­culas Populares</h2>
    <div class="movie-grid" id="popular-grid">
      <p style="color: #ccc;">Cargando populares...</p>
    </div>

    <br><br>

    <h2 class="section-title" id="dynamic-genre-title">âœ¨ Descubre mÃ¡s</h2>
    <div class="movie-grid" id="genre-grid">
      <p style="color: #ccc;">Buscando recomendaciones...</p>
    </div>

    <br><br>

    <h2 class="section-title" id="decade-title">ğŸ•°ï¸ Viaje en el tiempo</h2>
    <div class="movie-grid" id="decade-grid">
        <p style="color: #ccc;">Cargando clÃ¡sicos...</p>
    </div>

    <div id="social-feed" style="margin-top: 40px;">
        </div>

  </main>

  <nav class="bottom-menu">
    <a onclick="location.href='../profile/Profile.html'" class="menu-item" title="Perfil">ğŸ‘¤</a>
    <a onclick="location.href='../logout/Logout.html'" class="menu-item" title="Salir">ğŸšª</a>
  </nav>

  <script>
    // FunciÃ³n para crear tarjetas
    function createMovieCard(movie) {
        const card = document.createElement('a');
        card.href = `../movie-details/Movie-details.html?id=${movie.id_pelicula}`;
        card.className = 'movie-card';

        const img = document.createElement('img');
        img.src = movie.imagen || 'https://via.placeholder.com/200x300?text=No+Image';
        img.alt = movie.nombre;
        img.onerror = () => img.src = 'https://via.placeholder.com/200x300?text=Error';

        const title = document.createElement('p');
        title.textContent = movie.nombre;

        card.appendChild(img);
        card.appendChild(title);
        return card;
    }

    document.addEventListener('DOMContentLoaded', function() {
      
      // A. CARGA POPULARES Y GÃ‰NERO
      fetch('../../controladores/get_home_dynamic.php')
        .then(response => response.json())
        .then(data => {
          // Populares
          const popularGrid = document.getElementById('popular-grid');
          popularGrid.innerHTML = '';
          if (data.populares && data.populares.length > 0) {
            data.populares.forEach(movie => popularGrid.appendChild(createMovieCard(movie)));
          }

          // GÃ©nero
          const genreGrid = document.getElementById('genre-grid');
          const genreTitle = document.getElementById('dynamic-genre-title');
          genreGrid.innerHTML = '';
          if (data.genero_titulo && data.genero_peliculas.length > 0) {
            genreTitle.textContent = `PelÃ­culas de ${data.genero_titulo}`;
            data.genero_peliculas.forEach(movie => genreGrid.appendChild(createMovieCard(movie)));
          } else {
             genreTitle.textContent = "Explora nuestro catÃ¡logo";
          }
        });

      // B. CARGA POR DÃ‰CADA (NUEVO)
      fetch('../../controladores/get_movies_by_decade_controller.php')
        .then(response => response.json())
        .then(data => {
            const decadeGrid = document.getElementById('decade-grid');
            const decadeTitle = document.getElementById('decade-title');
            decadeGrid.innerHTML = '';

            if (data.movies && data.movies.length > 0) {
                decadeTitle.textContent = `ğŸ•°ï¸ ${data.titulo}`; // Ej: Cine de los 2000
                data.movies.forEach(movie => decadeGrid.appendChild(createMovieCard(movie)));
            } else {
                decadeGrid.innerHTML = '<p>No se encontraron pelÃ­culas de esta Ã©poca hoy.</p>';
            }
        });

      // C. CARGA SOCIAL (3 AMIGOS)
      fetch('../../controladores/get_followed_reviews_controller.php')
        .then(response => response.json())
        .then(amigos => {
            const socialFeed = document.getElementById('social-feed');
            socialFeed.innerHTML = ''; // Limpiar

            if (amigos.length > 0) {
                // Agregamos un tÃ­tulo general si hay actividad
                const mainTitle = document.createElement('h2');
                mainTitle.className = 'section-title';
                mainTitle.textContent = 'ğŸ‘¥ Actividad de amigos';
                socialFeed.appendChild(mainTitle);

                // Iteramos sobre cada amigo encontrado
                amigos.forEach(data => {
                    // 1. Contenedor para este amigo
                    const friendSection = document.createElement('div');
                    friendSection.style.marginBottom = '30px';

                    // 2. Cabecera del amigo (Avatar + Nombre)
                    const letter = data.user.nombre_usuario.charAt(0).toUpperCase();
                    const avatarUrl = data.user.foto_perfil || `https://via.placeholder.com/40/461561/ffffff?text=${letter}`;
                    
                    friendSection.innerHTML = `
                        <a href="../user-profile/User-profile.html?id=${data.user.id_usuario}" 
                           style="text-decoration: none; display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                             <img src="${avatarUrl}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #723680;">
                             <span style="color: #ddd; font-weight: bold; font-size: 1.1rem;">@${data.user.nombre_usuario}</span>
                             <span style="color: #888; font-size: 0.9rem;">ha reseÃ±ado:</span>
                        </a>
                    `;

                    // 3. Grid de sus pelÃ­culas
                    const grid = document.createElement('div');
                    grid.className = 'movie-grid'; // Reutilizamos tu clase CSS de grid
                    
                    data.movies.forEach(movie => {
                        grid.appendChild(createMovieCard(movie));
                    });

                    friendSection.appendChild(grid);
                    socialFeed.appendChild(friendSection);
                });
            }
        })
        .catch(err => console.error("Error cargando social:", err));
    });
  </script>
</body>
</html>