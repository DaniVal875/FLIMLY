<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CineRese√±as - Inicio</title>
  <link rel="stylesheet" href="Home.css">
</head>

<body>
  <header class="top-bar">
    <h1 class="logo">üé¨ CineRese√±as</h1>
    <div class="search-box">
      <input type="text" placeholder="Buscar pel√≠culas..." id="searchInput">
      <button onclick="buscar()">üîç</button>
    </div>
  </header>
  <script>
    function buscar() {
      const query = document.getElementById("searchInput").value;
        if (query.trim() !== "") {
            window.location.href = `../search-results/Search-results.html?query=${encodeURIComponent(query)}`;
        }
    }
  </script>

  <main class="movies-section">
    
    <h2 class="section-title">üî• Pel√≠culas Populares</h2>
    <div class="movie-grid" id="popular-grid">
      <p style="color: #ccc;">Cargando populares...</p>
    </div>

    <br><br> <h2 class="section-title" id="dynamic-genre-title">‚ú® Descubre m√°s</h2>
    <div class="movie-grid" id="genre-grid">
      <p style="color: #ccc;">Buscando recomendaciones...</p>
    </div>

  </main>

  <nav class="bottom-menu">
    <a onclick="location.href='../profile/Profile.html'" class="menu-item" title="Perfil">üë§</a>
    <a onclick="location.href='../logout/Logout.html'" class="menu-item" title="Salir">üö™</a>
  </nav>

  <script>
    // Funci√≥n auxiliar para crear tarjetas de pel√≠cula
    function createMovieCard(movie) {
        const card = document.createElement('a');
        card.href = `../movie-details/Movie-details.html?id=${movie.id_pelicula}`;
        card.className = 'movie-card';

        const img = document.createElement('img');
        img.src = movie.imagen || 'https://via.placeholder.com/200x300?text=No+Image';
        img.alt = movie.nombre;
        img.onerror = () => img.src = 'https://via.placeholder.com/200x300?text=Error';

        const title = document.createElement('p');
        title.textContent = movie.nombre;

        card.appendChild(img);
        card.appendChild(title);
        return card;
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Llamamos al nuevo controlador din√°mico
      fetch('../../controladores/get_home_dynamic.php')
        .then(response => response.json())
        .then(data => {
          
          // 1. Rellenar Secci√≥n POPULARES
          const popularGrid = document.getElementById('popular-grid');
          popularGrid.innerHTML = ''; // Limpiar mensaje de carga
          
          if (data.populares && data.populares.length > 0) {
            data.populares.forEach(movie => {
              popularGrid.appendChild(createMovieCard(movie));
            });
          } else {
              popularGrid.innerHTML = '<p>No hay pel√≠culas populares disponibles.</p>';
          }

          // 2. Rellenar Secci√≥n G√âNERO DIN√ÅMICO
          const genreGrid = document.getElementById('genre-grid');
          const genreTitle = document.getElementById('dynamic-genre-title');
          genreGrid.innerHTML = ''; // Limpiar mensaje

          if (data.genero_titulo && data.genero_peliculas.length > 0) {
            // Actualizamos el t√≠tulo (Ej: "Pel√≠culas de Terror")
            genreTitle.textContent = `Pel√≠culas de ${data.genero_titulo}`;
            
            data.genero_peliculas.forEach(movie => {
              genreGrid.appendChild(createMovieCard(movie));
            });
          } else {
             // Si por azar sale un g√©nero sin pel√≠culas, ocultamos la secci√≥n o mostramos mensaje
             genreTitle.textContent = "Explora nuestro cat√°logo";
             genreGrid.innerHTML = '<p>No se encontraron recomendaciones espec√≠ficas hoy.</p>';
          }

        })
        .catch(error => {
          console.error('Error:', error);
        });
    });
  </script>
</body>
</html>
// ... (c√≥digo HTML anterior sigue igual) ...

  <script>
    function irAAgregarResena() {
        const params = new URLSearchParams(window.location.search);
        const movieId = params.get('id');
        // Si hay ID, vamos al formulario de agregar rese√±a
        if(movieId) location.href = `../add-review/Add-review.html?id=${movieId}`;
    }

    document.addEventListener('DOMContentLoaded', function() {
      const params = new URLSearchParams(window.location.search);
      const movieId = params.get('id');

      if (!movieId) return;

      // 1. CARGAR INFO DE LA PEL√çCULA (Igual que antes)
      fetch(`../../controladores/get_movie_details_controller.php?id=${movieId}`)
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                document.getElementById('title').textContent = data.nombre;
                document.getElementById('desc').textContent = data.sinopsis;
                document.getElementById('year').textContent = data.fecha_estreno;
                document.getElementById('duration').textContent = data.duracion;
                document.getElementById('director').textContent = data.directores || 'Desconocido';
                document.getElementById('genre').textContent = data.generos || 'Sin g√©nero';
                document.getElementById('language').textContent = data.idiomas || 'Desconocido';
                
                const img = document.getElementById('poster');
                img.src = data.imagen || 'https://via.placeholder.com/300x450?text=No+Image';
            }
        });

      // 2. CARGAR RESE√ëAS (NUEVO)
      fetch(`../../controladores/get_reviews_controller.php?id=${movieId}`)
        .then(response => response.json())
        .then(reviews => {
            const container = document.getElementById('reviews-container');
            container.innerHTML = ''; // Limpiar mensaje de carga

            if (reviews.length > 0) {
                reviews.forEach(review => {
                    // Crear HTML de la tarjeta de rese√±a
                    const card = document.createElement('div');
                    card.className = 'review-card';
                    
                    // Generamos las estrellas visualmente
                    let starsHTML = '';
                    for(let i=1; i<=5; i++) {
                        // Si la calificacion es sobre 10, dividimos entre 2. Si es sobre 5, se deja igual.
                        // Asumiendo que guardas del 1 al 5 en el formulario:
                        starsHTML += i <= review.calificacion ? '<span class="circle">‚≠ê</span>' : '<span class="circle empty">‚≠ê</span>';
                    }

                    card.innerHTML = `
                        <div class="review-content">
                            <h4 class="username">@${review.nombre_usuario} <small style="color:#aaa; font-weight:normal;">(${review.fecha_pub})</small></h4>
                            <div class="rating">
                                ${starsHTML}
                            </div>
                            <p>${review.texto_resenia}</p>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } else {
                container.innerHTML = '<p>A√∫n no hay rese√±as. ¬°S√© el primero en opinar!</p>';
            }
        });
    });
  </script>