<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Filmly - Mi Perfil</title>
  <link rel="stylesheet" href="Profile.css">
</head>
<body>
  <header class="top-bar">
    <button class="back-btn" onclick="window.location.href='../home/Home.html'" title="Volver al inicio">
      ‚¨Ö
    </button>
    <h1 class="page-title">Mi Perfil</h1>
  </header>

  <section class="profile-info" >
    <div class="avatar">
      <img src="" alt="Foto de perfil">
    </div>
    
    <h2 class="username" id="profile-username">Cargando...</h2>
    <p class="bio" id="profile-bio">...</p>

    <div class="stats">
      <div class="stat">
        <span class="number" id="profile-followers">0</span>
        <span class="label">Seguidores</span>
      </div>
      <div class="stat">
        <span class="number" id="profile-following">0</span>
        <span class="label">Siguiendo</span>
      </div>
      <div class="stat">
        <span class="number" id="profile-reviews-count">0</span>
        <span class="label">Publicaciones</span>
      </div>
    </div>

    <div class="actions">
      <button class="btn edit" onclick="location.href='../edit-profile/Edit-Profile.html'">‚úèÔ∏è Editar</button>
      <button class="btn share">üîó Compartir</button>
    </div>
  </section>

  <section class="reviews">
    <h3 class="section-title">Mis Rese√±as</h3>
    <div class="review-list" id="my-reviews-container">
      <p style="text-align:center; color:#888;">Cargando tus rese√±as...</p>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      
      // 1. CARGAR DATOS DEL PERFIL
      fetch('../../controladores/get_profile_controller.php')
        .then(response => {
          if (!response.ok) window.location.href = '../login/Login.html';
          return response.json();
        })
        .then(data => {
          if (data) {
            document.getElementById('profile-username').textContent = data.nombre_usuario || 'Usuario';
            document.getElementById('profile-bio').textContent = data.descripcion || 'Sin descripci√≥n.';
            document.getElementById('profile-followers').textContent = data.seguidores || 0;
            document.getElementById('profile-following').textContent = data.seguidos || 0;
            
            const img = document.querySelector('.avatar img');
            img.src = data.foto_perfil || "https://tse1.mm.bing.net/th/id/OIP.rAxz10iucNJJPeb6wRPZjAHaHa?cb=12&rs=1&pid=ImgDetMain&o=7&rm=3";
            img.onerror = function() { this.src = "https://tse1.mm.bing.net/th/id/OIP.rAxz10iucNJJPeb6wRPZjAHaHa?cb=12&rs=1&pid=ImgDetMain&o=7&rm=3"; };
          }
        })
        .catch(error => console.error('Error perfil:', error));

      // 2. CARGAR MIS RESE√ëAS
      fetch('../../controladores/get_my_reviews_controller.php')
        .then(response => response.json())
        .then(reviews => {
            const container = document.getElementById('my-reviews-container');
            container.innerHTML = ''; 

            document.getElementById('profile-reviews-count').textContent = reviews.length;

            if (reviews.length > 0) {
                reviews.forEach(review => {
                    const card = document.createElement('a');
                    card.href = `../movie-details/Movie-details.html?id=${review.id_pelicula}`;
                    card.className = 'review-card'; // Clase principal
                    
                    // Generar estrellas (c√≠rculos morados/amarillos como en tu imagen)
                    let starsHTML = '';
                    for(let i=1; i<=5; i++) {
                        // Si i es menor o igual a la calificaci√≥n, estrella llena (amarilla/morada)
                        // Si no, vac√≠a o gris. Usaremos emojis para asegurar color r√°pido o spans con estilo.
                        // Basado en tu imagen, parecen iconos s√≥lidos.
                        if(i <= review.calificacion) {
                             starsHTML += '<span style="color: #FFC107; margin-right:2px;">‚≠ê</span>'; 
                        } else {
                             starsHTML += '<span style="color: #555; margin-right:2px;">‚≠ê</span>'; 
                        }
                    }

                    // ESTRUCTURA EXACTA DE TU IMAGEN
                    card.innerHTML = `
                        <img src="${review.imagen || 'https://via.placeholder.com/80x120'}" 
                             alt="${review.nombre_pelicula}" 
                             class="movie-poster"> 
                        
                        <div class="review-content">
                            <h4>${review.nombre_pelicula}</h4>
                            
                            <p class="review-text">"${review.texto_resenia}"</p>
                            
                            <div class="rating">${starsHTML}</div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } else {
                container.innerHTML = '<p style="text-align:center; color:#aaa; margin-top:20px;">No hay rese√±as publicadas.</p>';
            }
        })
        .catch(error => console.error('Error rese√±as:', error));
    });
  </script>
</body>
</html>